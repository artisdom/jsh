#ifndef READLINE_HPP
#define READLINE_HPP

#include <node.h>

class ReadLine : public node::ObjectWrap
{
public:
    static void init(v8::Handle<v8::Object> target);

private:
    ReadLine();
    ~ReadLine();

    static v8::Handle<v8::Value> New(const v8::Arguments& args);
    static v8::Handle<v8::Value> resume(const v8::Arguments& args);
    static v8::Handle<v8::Value> cleanup(const v8::Arguments& args);

    static void RunCallback(uv_async_t* handle, int /*status*/);
    static void Run(uv_work_t *req);
    static void Done(uv_work_t *req, int /*status*/);
    static void handleReadLine(char* line);
    static char** attemptShellCompletion(const char* text, int start, int end);

    char** handleComplete(char* text, int start, int end);
    void handleLine(char* line);
    void cleanup();
    void wakeup(char c = 'w');
    void quit();

private:
    uv_loop_t* loop;
    uv_work_t work;
    uv_async_t async;
    int rlPipe[2];
    int stdoutPipe[2];
    int stderrPipe[2];

private:
    static v8::Persistent<v8::FunctionTemplate> constructor;
    v8::Persistent<v8::Function> lineCallback, completeCallback;
};

#endif
