var pc = require('ProcessChain');
var helper = undefined;

function addFunction(data)
{
    // run git status
    var git = global.jsh.pathify(data.entry.entry[0].data);
    var out = jsh.jshNative.execSync(git, ["status", "-u", "--porcelain"]);

    // find the root
    var root = jsh.jshNative.execSync(git, ["rev-parse", "--show-toplevel"]);
    // find our relative path compared to that
    var cwd = process.cwd();
    var extra = cwd.substr(root.length);
    if (extra.length > 0) {
        var cnt = extra.split('/').length;
        extra = "";
        for (var i = 0; i < cnt; ++i) {
            extra += "../";
        }
    } else {
        extra = "";
    }

    // parse
    if (out === undefined || !out.length)
        return [];
    var lst = out.split('\n');
    var rx = /^ *([^ ]+) +(.*)$/, e;

    var cands = [];
    for (var idx = 0; idx < lst.length; ++idx) {
        if ((e = rx.exec(lst[idx]))) {
            if (e[1][0] === "M" || e[1][0] === "?")
                cands.push(extra + e[2]);
        }
    }
    return cands;
}

function initHelper()
{
    helper = new (require('Completion')).Helper();
    helper.set({ cmds: { add: addFunction }});
}

function complete(data)
{
    if (!helper)
        initHelper();
    var cands = helper.complete(data);
    if (typeof cands === "string")
        cands += " ";
    else if (typeof cands === "object" && cands.length === 1)
        cands[0] += " ";
    return cands;
};

module.exports = complete;
